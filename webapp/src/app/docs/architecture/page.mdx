# Architecture

This project uses:

- A data pipeline running in [**Lambdas**](https://aws.amazon.com/lambda/) orchestrated by [**Step Functions**](https://aws.amazon.com/step-functions/) on [**AWS**](https://aws.amazon.com/)
- An [**OpenSearch**](https://opensearch.org/) cluster running on [**bonsai.io**](https://bonsai.io), for storing and searching the data.
- [**Gemini**](https://ai.google.dev/gemini-api) 2.5 Flash and Flash-Lite from Google AI, for extracting data from the CAC decisions.
- [**Next.js**](https://nextjs.org/) hosted on [**Vercel**](https://vercel.com/), for the web application.

It relies on [**Terraform**](https://www.terraform.io/) for cloud infrastructure management, and [**BAML**](https://boundaryml.com/) for type-safe LLM prompting and structured data extraction. The scraping is done using [**scrapy**](https://scrapy.org/). The frontend is built using [**Tailwind CSS**](https://tailwindcss.com/) and [**shadcn/ui**](https://ui.shadcn.com/) components.

It looks something like this:

![The architecture diagram for this project](/assets/architecture.png)

BAML is really excellent for the data extraction tasks, as shown by the suite of evaluation tests that can be found in the GitHub repository. Gemini 2.5 Flash-Lite shows good performance, but the pipeline will fall back to 2.5 Flash if the LLM calls fail validation.

Once the data is extracted, it's transformed into the event-based format with a state machine for validation:

<br />

```mermaid
---
State Machine
---
stateDiagram-v2
  direction LR
  classDef s_default fill:white,color:black
  classDef s_inactive fill:white,color:black
  classDef s_parallel color:black,fill:white
  classDef s_active color:red,fill:darksalmon
  classDef s_previous color:blue,fill:azure

  state "initial" as initial
  Class initial s_active
  state "withdrawn" as withdrawn
  Class withdrawn s_default
  state "pending_application_decision" as pending_application_decision
  Class pending_application_decision s_default
  state "application_rejected" as application_rejected
  Class application_rejected s_default
  state "pending_recognition_decision" as pending_recognition_decision
  Class pending_recognition_decision s_default
  state "balloting" as balloting
  Class balloting s_default
  state "recognized" as recognized
  Class recognized s_default
  state "not_recognized" as not_recognized
  Class not_recognized s_default
  state "method_agreed" as method_agreed
  Class method_agreed s_default
  state "closed" as closed
  Class closed s_default

  initial --> pending_application_decision: application_received
  pending_application_decision --> pending_application_decision: application_p35_valid
  pending_application_decision --> application_rejected: application_p35_invalid | application_rejected
  pending_application_decision --> withdrawn: application_withdrawn
  pending_application_decision --> pending_recognition_decision: application_accepted
  pending_recognition_decision --> withdrawn: application_withdrawn
  pending_recognition_decision --> application_rejected: application_rejected
  pending_recognition_decision --> pending_recognition_decision: bargaining_unit_appropriate | bargaining_unit_inappropriate | ballot_requirement_decided | ballot_not_required | ballot_form_postal | ballot_form_workplace | ballot_form_combination
  pending_recognition_decision --> recognized: union_recognized
  pending_recognition_decision --> balloting: ballot_held
  pending_recognition_decision --> closed: case_closed
  balloting --> recognized: union_recognized
  balloting --> not_recognized: union_not_recognized
  recognized --> method_agreed: method_decision | method_agreed
  recognized --> closed: case_closed
  [*] --> initial
```
